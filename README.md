# PythonProject_HanaChoi

## 1. 미션 요구사항 분석 & 체크리스트

---

### 1-1. 미션 요구사항 분석

---

```python
1. 사용자는 도서 정보를 입력할 수 있다.
(입력 정보)
- 도서의 ID, 이름, 저자, 출판사
(상세 조건)
- 하나라도 비어있을 경우 입력이 되지 않는다. 

2. 사용자는 도서 정보를 조회할 수 있다.
(출력 정보)
- 도서의 ID, 이름, 저자, 출판사 정보가 출력된다. 
(상세 조건)
- 이름으로 조회 가능
- 해당 텍스트가 포함된 도서 정보를 모두 출력한다.

3. 사용자는 도서 정보를 입력해서 대출을 할 수 있다.
(변경 정보)
- 도서의 상태가 "대출중"으로 변경된다.
- 대출 시점이 기록된다. 

4. 사용자는 도서 정보를 입력해서 반납을 할 수 있다. 
- 사용자 정보를 입력하면 대출중인 도서 정보가 출력되고, 그 중에 선택해서 반납할 수 있다. 
- 반납하면 도서정보가 "반납 완료" 로 변경되고, 반납 완료 시점이 기록된다. 

5. 사용자는 대출했던 도서 리스트를 볼 수 있다. 
- 전체 도서의 대여 상태가 같이 출력된다. 
- 대여일 기준 내림차순 (최근 대여일순) 으로 정렬된다. 

```

### 1-2. 미션 체크리스트
```python
[v] 미션 요구사항 분석 
[v] 메뉴 프린트 & 사용자 입력으로 메뉴 선택하기 
[v] DB 구조 설계 
[v] DB 및 테이블 생성 
[] 사용자의 메뉴 선택에 따른 기능 제공 
    [v] 도서 정보 조회 
    [v] 도서 대출
    [v] 도서 반납 
    [v] 대출 도서 조회
    [v] 종료

```

## 2. 미션 진행 & 회고

---

### 2-1. 미션 진행 내용 요약

---



#### 2-1-1.  DB 구조 설계
```
최대한 각 테이블이 중복 없이 데이터를 쌓을 수 있도록 고려해서 설계하였습니다. 
책의 정보를 담은 books와 사용자 정보를 담은 users 테이블이 있고, 사용자가 책을 대여하는 정보를 쌓는 rentals 테이블을 정의했습니다. 

*참고 문서: postsql 공식 document 
```

1. books


| 컬럼명       | 상세    | key                | data type |
|-----------|-------|--------------------|-----------|
| id        | 아이디   | pk                 | int       |
| title     | 제목    |                    | text      | 
| author    | 저자명   |                    | text      | 
| publisher | 출판사   |                    | text      |

2. users

| 컬럼명  | 상세  | key | data type |
|------|-----|-----|-----|
| id   | 아이디 | pk  | int |
| name | 이름  |     | text |

3. rentals

| 컬럼명       | 상세      | key           | data type |
|-----------|---------|---------------|-----------|
| id        | 아이디     | pk            | int       |
| book_id   | 책 아이디   | fk (books/id) | int |
| user_id   | 사용자 아이디 | fk (users/id) | int |
| status    | 대여 상태   | | text |
| rental_at | 대여 일자   | | date_time|
| return_at | 반납 일자   | | date_time|

#### 2-1-2. 도서 정보 조회 기능
```
유저가 조회하기 원하는 책 이름을 입력받아서 해당 문장이 포함된 도서 정보를 출력했습니다. 

쿼리
f"""SELECT books.*, 
    case when rentals.status is null then '대여 가능'
         when rentals.status = '반납 완료' then '대여 가능' 
         else status end as status
   FROM books 
   LEFT JOIN rentals on books.id= rentals.book_id 
   WHERE title like '%{book_name}%';"""

- 쿼리문 안에 input으로 입력받은 변수값을 넣어주기 위해 { } 를 사용했습니다. 
- rentals 테이블과 조인하여 대여 가능 여부도 표기하였습니다. -> 대여 이력이 없을 경우 rentals에 row가 없기 때문에 case when 구문으로 
대여 가능으로 표기해주었습니다. 

```

#### 2-1-3. 도서 대출 기능
```
1. 대여하고 싶은 책 정보 받기
- books에 있는 책인지 확인합니다.
- rentals 테이블에서 해당 책이 대여 가능한 상태인지 확인합니다.

2. 사용자 정보 받기
- users 테이블에 있는 사용자인지 확인합니다.

3. 대여하기
- 책이 대여가능한 상태이며, 유효한 사용자인 경우 입력받은 책 정보, 사용자 정보를 사용하여 rentals 테이블에 입력해줍니다. 

쿼리
f"""INSERT INTO rentals (book_id, user_id, status) 
    VALUES ({book_id},{user_id},'대여중');"""
```

#### 2-1-4. 도서 반납 기능 
```
1. 사용자 정보 받기
- 현재 대여중인 도서 목록을 먼저 리스트로 보여주기 위해 사용자 정보를 입력받습니다. 
2. 대여중인 도서 목록 보여주기
- rentals 테이블과 users 테이블을 조인하여 해당 유저가 대여중인 도서 목록을 받아옵니다.
- 대여중인 도서가 없을 경우 종료되고 메인으로 돌아갑니다. 
3. 반납하기
- 대여중인 도서중에 반납하고 싶은 책 id 를 입력받습니다.
- 대여중인 도서 목록에 있는 책인지 확인합니다.
- 도서 목록에 없는 책일 경우 다시 물어봅니다.
- 도서 목록에 있는 책일 경우 rentals 의 해당 컬럼 값을 업데이트해줍니다.
    - status = '대여중' -> status = '반납 완료'
    - return_at is null -> return_at = now()
* 이전에 같은 책을 대여했을 수 있기 때문에, status = '대여중' 인 조건을 추가해줍니다. 
    
쿼리
f"""UPDATE rentals 
    SET 
       return_at = now(), 
       status = '반납 완료'
    WHERE 
       book_id = {book_id}
       and status = '대여중'
       and user_id = {user_id};"""
```

#### 2-1-5. 대출 정보 조회 기능
```
1. 대출 정보를 조회할 사용자 이름을 입력받습니다. 
2. rentals 테이블과 users 테이블을 조인하여 해당 유저의 대출 목록을 출력합니다. 
3. 목록 맨 앞에 대출 상태를 표기해주었습니다.
4. 대출 일자 기준 내림차순으로 정렬하여 가장 최근에 대출한 항목 순서대로 출력합니다. 

쿼리
f"""SELECT r.id, b.title, b.author, b.publisher, r.rental_at, u.name, r.book_id, r.status,r.return_at
    FROM rentals as r 
    INNER JOIN users as u on r.user_id = u.id and u.name = '{user_name}'
    INNER JOIN books as b on r.book_id = b.id 
    ORDER BY r.id desc;"""
```

### 2-2. 회고

---

```
[수정하고 싶은 부분]
- users 테이블에서 name에 unique 조건을 넣어주어서 중복된 이름이 들어가지 않도록 수정 필요합니다. 
- 도서 반납에서 사용자가 있는지, 도서목록이 있는지 등을 확인하는 과정에서 중첩 if문, for문이 작성된 부분 수정하고 싶습니다.
- 전체적으로 함수로 작성되어있는데, 클래스화해서 깔끔하게 작성하고 싶습니다. 

[느낀점]
- 처음에 db구조를 설계하고 기능 구현을 시작했는데, 기능을 구현하다보니 db 설계해놓은것을 수정해야하기도 했습니다.
- db에 없는 값을 입력했을때 발생하는 오류 처리도 자꾸 발생해서 테스트를 꼼꼼히 했는데, 오류가 더 발생할 수 있을것 같습니다.
- 다 구현해놓고 테스트하는 과정에서 불편함이 느껴져 수정된 부분이 있었습니다. (전체적으로 뒤로가기가 없어서 프로그램을 강제 종료 해야하는 부분)
- 다시 코드를 봤을 때 복잡하게 느껴져서 깔끔하게 정리하는게 필요할 것 같습니다. 

```